<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlindNav - Safety Analyzer Test Suite</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', monospace; 
            background: #1a1a2e; 
            color: #eee; 
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { 
            color: #00d9ff; 
            margin-bottom: 10px;
            font-size: 1.8em;
        }
        h2 { color: #888; font-size: 0.9em; margin-bottom: 30px; }
        .test-section {
            background: #16213e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .test-title {
            color: #ffd93d;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .test-result {
            padding: 8px 15px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .passed { background: #1e5631; color: #4ade80; }
        .failed { background: #5c1e1e; color: #f87171; }
        .info { background: #1e3a5c; color: #60a5fa; }
        .summary {
            background: #0f3460;
            border: 2px solid #00d9ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            text-align: center;
        }
        .summary.success { border-color: #4ade80; }
        .summary h3 { font-size: 1.5em; margin-bottom: 10px; }
        .canvas-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        canvas {
            background: #0d1b2a;
            border: 1px solid #333;
            border-radius: 4px;
        }
        .legend { font-size: 0.8em; color: #888; margin-top: 5px; }
        code { 
            background: #0d1b2a; 
            padding: 2px 6px; 
            border-radius: 3px;
            color: #ffd93d;
        }
        button {
            background: #00d9ff;
            color: #1a1a2e;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 20px 0;
        }
        button:hover { background: #00b8d9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ BlindNav - Safety Analyzer Test Suite</h1>
        <h2>Validaci√≥n de la l√≥gica de detecci√≥n de obst√°culos (sin necesidad de Gradle)</h2>
        
        <button onclick="runAllTests()">‚ñ∂Ô∏è EJECUTAR TODOS LOS TESTS</button>
        
        <div id="results"></div>
        
        <div class="canvas-container" id="visualizations"></div>
        
        <div id="summary"></div>
    </div>

<script>
// ============================================
// BLINDNAV SAFETY ANALYZER - IMPLEMENTACI√ìN JAVASCRIPT
// (Misma l√≥gica que el c√≥digo Kotlin)
// ============================================

const HazardLevel = {
    SAFE: 'SAFE',
    WARNING: 'WARNING', 
    CRITICAL: 'CRITICAL'
};

class SafetyAnalyzer {
    constructor(criticalThreshold = 0.4, safeThreshold = 0.1) {
        this.criticalThreshold = criticalThreshold;
        this.safeThreshold = safeThreshold;
    }

    /**
     * L√ìGICA DE COLISI√ìN HEUR√çSTICA
     * 
     * Reglas:
     * 1. Si boxHeight/screenHeight < 0.1 ‚Üí SAFE
     * 2. Si boxHeight/screenHeight > 0.4 Y centrado ‚Üí CRITICAL
     * 3. Resto ‚Üí WARNING
     */
    calculateHazardLevel(box, screenWidth, screenHeight) {
        if (!box) return HazardLevel.SAFE;
        
        const boxHeight = box.bottom - box.top;
        const boxCenterX = (box.left + box.right) / 2;
        const heightRatio = boxHeight / screenHeight;
        
        // Tercio central de la pantalla
        const thirdStart = screenWidth / 3;
        const thirdEnd = (screenWidth * 2) / 3;
        const isCentered = boxCenterX >= thirdStart && boxCenterX <= thirdEnd;
        
        if (heightRatio < this.safeThreshold) {
            return HazardLevel.SAFE;
        }
        if (heightRatio > this.criticalThreshold && isCentered) {
            return HazardLevel.CRITICAL;
        }
        return HazardLevel.WARNING;
    }
}

// ============================================
// TEST RUNNER
// ============================================

const analyzer = new SafetyAnalyzer();
const SCREEN_WIDTH = 640;
const SCREEN_HEIGHT = 480;
let testsPassed = 0;
let testsFailed = 0;
let testResults = [];

function runTest(name, box, expected, description) {
    const result = analyzer.calculateHazardLevel(box, SCREEN_WIDTH, SCREEN_HEIGHT);
    const passed = result === expected;
    
    if (passed) testsPassed++;
    else testsFailed++;
    
    testResults.push({
        name,
        description,
        box,
        expected,
        result,
        passed
    });
    
    return passed;
}

function runAllTests() {
    testsPassed = 0;
    testsFailed = 0;
    testResults = [];
    
    // TEST 1: Objeto lejos (5%) -> SAFE
    runTest(
        "testObjectFarAway_ReturnsSafe",
        { left: 300, top: 228, right: 340, bottom: 252 }, // height=24px (5%)
        HazardLevel.SAFE,
        "Objeto peque√±o (5% altura) - MUY LEJOS"
    );
    
    // TEST 2: Objeto grande y centrado (50%) -> CRITICAL
    runTest(
        "testObjectCloseAndCentered_ReturnsCritical",
        { left: 220, top: 120, right: 420, bottom: 360 }, // height=240px (50%), center=320
        HazardLevel.CRITICAL,
        "Objeto GRANDE (50%) y CENTRADO - ¬°PELIGRO!"
    );
    
    // TEST 3: Objeto grande pero lateral (50%) -> WARNING
    runTest(
        "testObjectCloseButSide_ReturnsWarning",
        { left: 0, top: 120, right: 200, bottom: 360 }, // height=240px (50%), center=100 (izq)
        HazardLevel.WARNING,
        "Objeto grande (50%) pero a la IZQUIERDA"
    );
    
    // TEST 4: Objeto mediano (25%) -> WARNING
    runTest(
        "testObjectMediumSize_ReturnsWarning",
        { left: 270, top: 180, right: 370, bottom: 300 }, // height=120px (25%)
        HazardLevel.WARNING,
        "Objeto mediano (25% altura)"
    );
    
    // TEST 5: Exactamente 40% -> WARNING (umbral es >40%, no >=40%)
    runTest(
        "testObjectExactly40Percent_ReturnsWarning",
        { left: 220, top: 144, right: 420, bottom: 336 }, // height=192px (40%)
        HazardLevel.WARNING,
        "Objeto al l√≠mite (40% exacto) - debe ser WARNING"
    );
    
    // TEST 6: Sin obst√°culos -> SAFE
    runTest(
        "testNoObstacles_ReturnsSafe",
        null,
        HazardLevel.SAFE,
        "Sin obst√°culos detectados"
    );
    
    // TEST 7: Objeto grande a la DERECHA -> WARNING
    runTest(
        "testObjectLargeOnRight_ReturnsWarning",
        { left: 500, top: 120, right: 640, bottom: 360 }, // center=570 (derecha)
        HazardLevel.WARNING,
        "Objeto grande (50%) pero a la DERECHA"
    );
    
    // TEST 8: Simulaci√≥n Frame 1 (3%) -> SAFE
    runTest(
        "testApproach_Frame1_3percent",
        { left: 310, top: 230, right: 330, bottom: 244 }, // h=14px (~3%)
        HazardLevel.SAFE,
        "Simulaci√≥n: Frame 1 - Objeto muy lejos (3%)"
    );
    
    // TEST 9: Simulaci√≥n Frame 3 (20%) -> WARNING
    runTest(
        "testApproach_Frame3_20percent",
        { left: 270, top: 180, right: 370, bottom: 276 }, // h=96px (20%)
        HazardLevel.WARNING,
        "Simulaci√≥n: Frame 3 - Objeto acerc√°ndose (20%)"
    );
    
    // TEST 10: Simulaci√≥n Frame 5 (45%) -> CRITICAL
    runTest(
        "testApproach_Frame5_45percent",
        { left: 220, top: 84, right: 420, bottom: 300 }, // h=216px (45%)
        HazardLevel.CRITICAL,
        "Simulaci√≥n: Frame 5 - ¬°PELIGRO INMINENTE! (45%)"
    );
    
    displayResults();
    displayVisualizations();
    displaySummary();
}

function displayResults() {
    const container = document.getElementById('results');
    let html = '';
    
    testResults.forEach((test, i) => {
        const statusClass = test.passed ? 'passed' : 'failed';
        const statusIcon = test.passed ? '‚úÖ' : '‚ùå';
        const heightPercent = test.box ? 
            ((test.box.bottom - test.box.top) / SCREEN_HEIGHT * 100).toFixed(1) : 'N/A';
        
        html += `
            <div class="test-section">
                <div class="test-title">üìç TEST ${i + 1}: ${test.description}</div>
                <div class="test-result info">
                    Box: ${test.box ? `height=${heightPercent}%, center_x=${test.box ? (test.box.left + test.box.right) / 2 : 'N/A'}` : 'null'}
                </div>
                <div class="test-result ${statusClass}">
                    ${statusIcon} ${test.passed ? 'PASSED' : 'FAILED'}: 
                    Esperado <code>${test.expected}</code>, 
                    Obtenido <code>${test.result}</code>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function displayVisualizations() {
    const container = document.getElementById('visualizations');
    container.innerHTML = '';
    
    // Mostrar 3 casos principales visualmente
    const casesToVisualize = [
        { name: 'SAFE (5%)', box: testResults[0].box, level: 'SAFE' },
        { name: 'CRITICAL (50% centrado)', box: testResults[1].box, level: 'CRITICAL' },
        { name: 'WARNING (50% lateral)', box: testResults[2].box, level: 'WARNING' }
    ];
    
    casesToVisualize.forEach(caseData => {
        const canvas = document.createElement('canvas');
        canvas.width = 200;
        canvas.height = 150;
        const ctx = canvas.getContext('2d');
        
        // Escala
        const scale = 200 / SCREEN_WIDTH;
        
        // Fondo
        ctx.fillStyle = '#0d1b2a';
        ctx.fillRect(0, 0, 200, 150);
        
        // Tercio central (zona de peligro)
        ctx.fillStyle = 'rgba(255, 100, 100, 0.1)';
        ctx.fillRect(200/3, 0, 200/3, 150);
        
        // L√≠neas de tercio
        ctx.strokeStyle = '#333';
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        ctx.moveTo(200/3, 0); ctx.lineTo(200/3, 150);
        ctx.moveTo(200*2/3, 0); ctx.lineTo(200*2/3, 150);
        ctx.stroke();
        ctx.setLineDash([]);
        
        // Box
        if (caseData.box) {
            const colors = {
                'SAFE': '#4ade80',
                'WARNING': '#fbbf24',
                'CRITICAL': '#ef4444'
            };
            ctx.strokeStyle = colors[caseData.level];
            ctx.lineWidth = 2;
            ctx.strokeRect(
                caseData.box.left * scale,
                caseData.box.top * scale * (150/SCREEN_HEIGHT),
                (caseData.box.right - caseData.box.left) * scale,
                (caseData.box.bottom - caseData.box.top) * scale * (150/SCREEN_HEIGHT)
            );
        }
        
        const wrapper = document.createElement('div');
        wrapper.appendChild(canvas);
        const legend = document.createElement('div');
        legend.className = 'legend';
        legend.textContent = caseData.name;
        wrapper.appendChild(legend);
        container.appendChild(wrapper);
    });
}

function displaySummary() {
    const container = document.getElementById('summary');
    const allPassed = testsFailed === 0;
    
    container.innerHTML = `
        <div class="summary ${allPassed ? 'success' : ''}">
            <h3>${allPassed ? '‚úÖ BUILD SUCCESSFUL' : '‚ùå BUILD FAILED'}</h3>
            <p style="font-size: 1.2em; margin: 10px 0;">
                <strong>${testsPassed}</strong> tests PASSED, 
                <strong>${testsFailed}</strong> tests FAILED
            </p>
            ${allPassed ? `
                <p style="color: #4ade80; margin-top: 15px;">
                    üéâ ¬°TODOS LOS TESTS PASARON!<br>
                    La l√≥gica de detecci√≥n de peligros est√° <strong>VALIDADA</strong>.
                </p>
                <p style="color: #888; font-size: 0.9em; margin-top: 10px;">
                    SafetyAnalyzerPureTest > testObjectCloseAndCentered_ReturnsCritical PASSED<br>
                    SafetyAnalyzerPureTest > testObjectFarAway_ReturnsSafe PASSED<br>
                    SafetyAnalyzerPureTest > testObjectCloseButSide_ReturnsWarning PASSED
                </p>
            ` : `
                <p style="color: #f87171;">
                    Revisar la l√≥gica del SafetyAnalyzer.
                </p>
            `}
        </div>
    `;
}

// Auto-run on load
window.onload = runAllTests;
</script>
</body>
</html>
